<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Suessmaus Karte Gemeindebau Wien</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@latest/ol.css">
  <style>
    html, body { margin: 0; height: 100%; }
    #map { width: 100%; height: 100%; }
    .panel {
      position: absolute;
      top: 12px;
      right: 12px;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.95);
      padding: 10px 12px;
      border-radius: 10px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      font-size: 14px;
      line-height: 1.4;
      width: 340px;
      max-width: calc(100% - 24px);
    }
    .panel h1 { margin: 0 0 6px; font-size: 16px; font-weight: 700; }
    .panel label { display: flex; align-items: center; gap: 6px; user-select: none; }
    .slider-row { display: flex; align-items: center; gap: 6px; margin-top: 4px; }
    .slider-row input[type="range"] { flex: 1; }
    .search-box { margin-top: 8px; }
    .search-input {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }
    .suggestions-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      margin-top: 2px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      max-height: 180px;
      overflow-y: auto;
      z-index: 1500;
    }
    .suggestions-item { padding: 6px 8px; cursor: pointer; }
    .suggestions-item:hover { background: #f0f4ff; }
    .legend {
      margin-top: 10px;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: rgba(255,255,255,0.95);
    }
    .legend-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      margin: 3px 0;
    }
    .legend-swatch {
      width: 22px;
      height: 12px;
      border: 1px solid #333;
      border-radius: 3px;
      flex-shrink: 0;
    }
    .ol-popup {
      position: absolute;
      background: white;
      padding: 8px 10px;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25);
      font-family: system-ui, sans-serif;
      font-size: 13px;
      min-width: 200px;
    }
    .ol-popup a { color: #1a73e8; text-decoration: none; }
    .ol-popup a:hover { text-decoration: underline; }
    @media (max-width: 540px) {
      .panel {
        left: 50%;
        right: auto;
        transform: translateX(-50%);
        width: calc(100% - 24px);
      }
    }
  </style>
</head>
<body>
  <div class="panel">
    <h1>Suessmaus Karte Gemeindebau Wien</h1>
    <div class="search-box">
      <div style="font-weight:600;">Suche (HOFNAME)</div>
      <div style="position:relative;">
        <input id="hof-search" class="search-input" type="text" placeholder="Tippe min. 3 Zeichen..." autocomplete="off">
        <div id="hof-suggestions" class="suggestions-list" style="display:none;"></div>
      </div>
    </div>
    <div style="margin-top:8px; margin-bottom:6px;">
      <strong>Basemap:</strong>
      <label style="margin-left:6px;"><input type="radio" name="basemap" value="bmap"> Topo</label>
      <label style="margin-left:6px;"><input type="radio" name="basemap" value="ortho" checked> Orthofoto</label>
    </div>
    <div style="margin-bottom:6px;">
      <label><input id="gemeindebau-toggle" type="checkbox" checked> Gemeindebau</label>
    </div>
    <div style="margin-top:4px;">
      <div style="font-weight:600;">Baujahr filtern</div>
      <div class="slider-row">
        <input id="year-min" type="range" min="1743" max="2025" value="1743">
        <input id="year-max" type="range" min="1743" max="2025" value="2025">
      </div>
      <div id="year-labels" style="font-size:12px; margin-top:2px;">1743 – 2025</div>
    </div>
    <div class="legend" id="legend"></div>
  </div>
  <div id="map"></div>

  <script src="https://cdn.jsdelivr.net/npm/ol@latest/dist/ol.js"></script>
  <script>
    const targetProjection = ol.proj.get("EPSG:3857");
    const minYearBase = 1743;
    const esriAttribution = 'Tiles © Esri';

    const vectorSource = new ol.source.Vector();
    const decadeColors = [
      "#7a0177", // <1900
      "#f7fcf0", "#e0f3db", "#ccebc5", "#a8ddb5", "#7bccc4",
      "#4eb3d3", "#2b8cbe", "#0868ac", "#084081", "#fc8d59",
      "#ef6548", "#d7301f", "#b30000", "#7f0000", "#49006a"
    ];
    const styleCache = {};
    function styleByYear(feature, resolution) {
      const y = parseInt(feature.get("BAUJAHR"), 10);
      let key = "unknown";
      if (Number.isFinite(y)) {
        if (y < 1900) key = "<1900";
        else {
          const idx = Math.floor((y - 1900) / 10);
          key = `d${idx}`;
        }
      }
      const width = Math.max(1, Math.min(6, 0.5 + resolution / 20)); // thicker when zoomed out
      const cacheKey = `${key}-${Math.round(width * 10)}`; // bucket by width
      if (!styleCache[cacheKey]) {
        let fillColor = "#cccccc";
        if (key === "<1900") fillColor = decadeColors[0];
        else if (key.startsWith("d")) {
          const idx = Math.min(decadeColors.length - 2, parseInt(key.slice(1), 10));
          fillColor = decadeColors[1 + idx] || decadeColors[decadeColors.length - 1];
        }
        styleCache[cacheKey] = new ol.style.Style({
          stroke: new ol.style.Stroke({ color: "#333", width }),
          fill: new ol.style.Fill({ color: fillColor + "cc" })
        });
      }
      return styleCache[cacheKey];
    }
    const gemeindebauLayer = new ol.layer.Vector({
      source: vectorSource,
      style: styleByYear
    });

    const baseLayerBmap = new ol.layer.Tile({
      source: new ol.source.XYZ({
        url: "https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",
        attributions: esriAttribution,
        crossOrigin: "anonymous",
        maxZoom: 19
      }),
      visible: false
    });
    const baseLayerOrtho = new ol.layer.Tile({
      source: new ol.source.XYZ({
        url: "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
        attributions: esriAttribution,
        crossOrigin: "anonymous",
        maxZoom: 19
      }),
      visible: true
    });

    const map = new ol.Map({
      target: "map",
      layers: [baseLayerBmap, baseLayerOrtho, gemeindebauLayer],
      view: new ol.View({
        projection: targetProjection,
        center: ol.proj.fromLonLat([16.3738, 48.2082], targetProjection),
        zoom: 15.5,
        minZoom: 4,
        maxZoom: 19
      })
    });

    document.querySelectorAll("input[name='basemap']").forEach((radio) => {
      radio.addEventListener("change", () => {
        const val = document.querySelector("input[name='basemap']:checked").value;
        baseLayerBmap.setVisible(val === "bmap");
        baseLayerOrtho.setVisible(val === "ortho");
      });
    });
    document.getElementById("gemeindebau-toggle").addEventListener("change", (e) => {
      gemeindebauLayer.setVisible(e.target.checked);
    });
    const searchInput = document.getElementById("hof-search");
    const suggestionsBox = document.getElementById("hof-suggestions");

    // Popup overlay
    const popupEl = document.createElement("div");
    popupEl.className = "ol-popup";
    const popup = new ol.Overlay({
      element: popupEl,
      autoPan: { animation: { duration: 200 } }
    });
    map.addOverlay(popup);

    // Load local GeoJSON and set up filtering
    fetch("GEMBAUTENFLOGD.json")
      .then((r) => {
        if (!r.ok) throw new Error(`GeoJSON load failed (${r.status})`);
        return r.json();
      })
      .then((data) => {
        const format = new ol.format.GeoJSON();
        const allFeatures = format.readFeatures(data, {
          dataProjection: "EPSG:4326",
          featureProjection: targetProjection
        });

        const years = allFeatures
          .map((f) => parseInt(f.get("BAUJAHR"), 10))
          .filter((n) => Number.isFinite(n));
        const minYear = Math.min(...years, minYearBase);
        const maxYear = Math.max(...years);
        const yearMin = document.getElementById("year-min");
        const yearMax = document.getElementById("year-max");
        const yearLabels = document.getElementById("year-labels");
        yearMin.min = minYearBase; yearMin.max = maxYear; yearMin.value = Math.max(minYearBase, minYear);
        yearMax.min = minYearBase; yearMax.max = maxYear; yearMax.value = maxYear;
        yearLabels.textContent = `${yearMin.value} – ${yearMax.value}`;

        const applyFilter = () => {
          const lo = Math.min(parseInt(yearMin.value, 10), parseInt(yearMax.value, 10));
          const hi = Math.max(parseInt(yearMin.value, 10), parseInt(yearMax.value, 10));
          yearLabels.textContent = `${lo} – ${hi}`;
          const filtered = allFeatures.filter((f) => {
            const y = parseInt(f.get("BAUJAHR"), 10);
            return Number.isFinite(y) && y >= lo && y <= hi;
          });
          vectorSource.clear(true);
          vectorSource.addFeatures(filtered);
        };
        yearMin.addEventListener("input", applyFilter);
        yearMax.addEventListener("input", applyFilter);

        vectorSource.addFeatures(allFeatures);
        applyFilter();

        // Legend
        const legendEl = document.getElementById("legend");
        const legendItems = [
          { label: "< 1900", color: decadeColors[0] }
        ];
        for (let start = 1900, i = 1; start <= 2020 && i < decadeColors.length; start += 10, i += 1) {
          const end = start + 9;
          legendItems.push({ label: `${start}-${end}`, color: decadeColors[i] || decadeColors[decadeColors.length - 1] });
        }
        legendEl.innerHTML = `<div style="font-weight:600; margin-bottom:4px;">Legende</div>` + legendItems.map(item =>
          `<div class="legend-row"><span class="legend-swatch" style="background:${item.color};"></span><span>${item.label}</span></div>`
        ).join("");

        // Search index
        const nameIndex = allFeatures
          .map((f) => ({
            id: f.getId() || f.ol_uid,
            name: (f.get("HOFNAME") || "").toString(),
            nameLc: (f.get("HOFNAME") || "").toString().toLowerCase(),
            feature: f
          }))
          .filter((n) => n.nameLc.length > 0);

        const renderSuggestions = (matches) => {
          if (!matches.length) {
            suggestionsBox.style.display = "none";
            return;
          }
          suggestionsBox.innerHTML = matches
            .slice(0, 8)
            .map((m) => `<div class="suggestions-item" data-id="${m.id}">${m.name}</div>`)
            .join("");
          suggestionsBox.style.display = "block";
        };

        const doSearch = (query, fly = false) => {
          const q = query.toLowerCase().trim();
          if (q.length < 3) {
            renderSuggestions([]);
            return;
          }
          const matches = nameIndex.filter((n) => n.nameLc.includes(q));
          renderSuggestions(matches);
          if (fly && matches.length) {
            const f = matches[0].feature;
            const geom = f.getGeometry();
            if (geom) {
              map.getView().fit(geom.getExtent(), { padding: [30, 30, 30, 30], duration: 200 });
            }
          }
        };

        searchInput.addEventListener("input", () => doSearch(searchInput.value));
        searchInput.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            doSearch(searchInput.value, true);
            suggestionsBox.style.display = "none";
          }
          if (e.key === "Escape") suggestionsBox.style.display = "none";
        });
        suggestionsBox.addEventListener("click", (e) => {
          const id = e.target.getAttribute("data-id");
          if (!id) return;
          const match = nameIndex.find((n) => (n.id || "").toString() === id.toString());
          if (match) {
            const geom = match.feature.getGeometry();
            if (geom) {
              map.getView().fit(geom.getExtent(), { padding: [30, 30, 30, 30], duration: 200 });
            }
            searchInput.value = match.name;
          }
          suggestionsBox.style.display = "none";
        });

        map.on("pointerdown", () => {
          suggestionsBox.style.display = "none";
        });
      })
      .catch((err) => {
        console.error(err);
        alert("Konnte die GeoJSON nicht laden. Details in der Konsole.");
      });

    // Click popup
    map.on("singleclick", (evt) => {
      popup.setPosition(undefined);
      map.forEachFeatureAtPixel(evt.pixel, (feature) => {
        const p = feature.getProperties();
        popupEl.innerHTML = `
          <div style="font-weight:700;margin-bottom:4px;">${p.HOFNAME || "Gemeindebau"}</div>
          <div><strong>Baujahr:</strong> ${p.BAUJAHR || "-"}</div>
          <div><strong>Adresse:</strong> ${p.ADRESSE || "-"}</div>
          <div><strong>Wohnungsanzahl:</strong> ${p.WOHNUNGSANZAHL ?? "-"}</div>
          <div><strong>Bezirk:</strong> ${p.BEZIRK ?? "-"}</div>
          <div><a href="${p.PDFLINK || "#"}" target="_blank" rel="noopener">PDF</a></div>
        `;
        popup.setPosition(evt.coordinate);
        return true;
      });
    });
  </script>
</body>
</html>
