<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Süßmaus Karte Gemeindebau Wien</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@latest/ol.css">
  <style>
    html, body { margin: 0; height: 100%; }
    #map { width: 100%; height: 100%; }
    .panel {
      position: absolute;
      top: 12px;
      left: 12px;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.92);
      padding: 10px 12px;
      border-radius: 6px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      font-size: 14px;
      line-height: 1.4;
    }
    .panel h1 {
      margin: 0 0 6px;
      font-size: 16px;
      font-weight: 700;
    }
    .panel label {
      display: flex;
      align-items: center;
      gap: 6px;
      user-select: none;
    }
  </style>
</head>
<body>
  <div class="panel">
    <h1>Süßmaus Karte Gemeindebau Wien</h1>
    <label><input id="gemeindebau-toggle" type="checkbox" checked> Gemeindebau</label>
  </div>
  <div id="map"></div>

  <!-- Use prebuilt OpenLayers bundle (avoids bare-specifier issues) -->
  <script src="https://cdn.jsdelivr.net/npm/proj4@2.9.1/dist/proj4.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ol@latest/dist/ol.js"></script>
  <script>
    const wmtsUrl = "https://mapsneu.wien.gv.at/basemap31256neu/1.0.0/WMTSCapabilities.xml";
    const wfsUrl = "https://data.wien.gv.at/daten/geo";
    const targetProjectionCode = "EPSG:31256";

    // Register EPSG:31256 for OL (Bessel + towgs84)
    proj4.defs(
      targetProjectionCode,
      "+proj=tmerc +lat_0=0 +lon_0=16 +k=1 +x_0=0 +y_0=-5000000 +ellps=bessel " +
        "+towgs84=577.326,90.129,463.919,5.137,1.474,5.297,2.4232 +units=m +no_defs"
    );
    ol.proj.proj4.register(proj4);
    const targetProjection = ol.proj.get(targetProjectionCode);

    async function buildMap() {
      // Parse WMTS capabilities for basemap.at (EPSG:31256)
      const wmtsResponse = await fetch(wmtsUrl);
      if (!wmtsResponse.ok) throw new Error(`WMTS capabilities request failed (${wmtsResponse.status})`);
      const capabilitiesText = await wmtsResponse.text();
      // Build WMTS source manually (avoids any axis-order quirks)
      const resolutions = [
        69359.0720514687, 34679.5360257344, 17339.7680128672, 8669.88400643359,
        4334.94200321679, 2167.4710016084, 1083.7355008042, 541.867750402099,
        270.93387520105, 135.466937600525, 67.7334688002624, 33.8667344001312,
        16.9333672000656, 8.4666836000328, 4.2333418000164, 2.1166709000082,
        1.0583354500041, 0.52916772500205, 0.264583862501025, 0.132291931250513
      ];
      const matrixIds = Array.from({ length: resolutions.length }, (_, i) => i.toString());
      const tileGrid = new ol.tilegrid.WMTS({
        origin: [5001000.0, -5622500.0],
        resolutions,
        matrixIds,
        tileSize: [256, 256]
      });

      const basemap = new ol.layer.Tile({
        source: new ol.source.WMTS({
          url: "https://mapsneu.wien.gv.at/basemap/bmap/{Style}/{TileMatrixSet}/{TileMatrix}/{TileRow}/{TileCol}.png",
          layer: "bmap",
          matrixSet: "31256",
          format: "image/png",
          style: "farbe",
          tileGrid,
          crossOrigin: "anonymous"
        })
      });

      const gemeindebauLayer = new ol.layer.Vector({
        source: new ol.source.Vector({
          format: new ol.format.GeoJSON({
            dataProjection: targetProjectionCode,
            featureProjection: targetProjectionCode
          }),
          url: `${wfsUrl}?service=WFS&version=1.1.0&request=GetFeature&typeName=${encodeURIComponent(
            "ogdwien:GEMBAUTENFLOGD"
          )}&srsName=${encodeURIComponent("urn:ogc:def:crs:EPSG::31256")}&outputFormat=application/json`
        }),
        style: new ol.style.Style({
          stroke: new ol.style.Stroke({ color: "#c0392b", width: 1.4 }),
          fill: new ol.style.Fill({ color: "rgba(192,57,43,0.25)" })
        })
      });

      const map = new ol.Map({
        target: "map",
        layers: [basemap, gemeindebauLayer],
        view: new ol.View({
          projection: targetProjection,
          center: ol.proj.fromLonLat([16.3738, 48.2082], targetProjection), // Vienna center
          zoom: 12,
          minZoom: 4,
          maxZoom: 18
        })
      });

      // Toggle visibility
      const toggle = document.getElementById("gemeindebau-toggle");
      toggle.addEventListener("change", () => {
        gemeindebauLayer.setVisible(toggle.checked);
      });
    }

    buildMap().catch((err) => {
      console.error("Map setup failed:", err);
      alert("Map setup failed. See console for details.");
    });
  </script>
</body>
</html>
