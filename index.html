<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Suessmaus Karte Gemeindebau Wien</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@latest/ol.css">
  <style>
    html, body { margin: 0; height: 100%; }
    #map { width: 100%; height: 100%; }
    .panel {
      position: absolute;
      top: 12px;
      right: 12px;
      z-index: 1000;
      background: #f5b342;
      padding: 10px 12px;
      border-radius: 10px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      font-size: 14px;
      line-height: 1.4;
      width: 340px;
      max-width: calc(100% - 24px);
    }
    .panel h1 { margin: 0 0 6px; font-size: 16px; font-weight: 700; }
    .panel label { display: flex; align-items: center; gap: 6px; user-select: none; }
    .toggle-row { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
    .search-box { margin-top: 8px; }
    .search-input {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }
    .suggestions-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      margin-top: 2px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      max-height: 180px;
      overflow-y: auto;
      z-index: 1500;
    }
    .suggestions-item { padding: 6px 8px; cursor: pointer; }
    .suggestions-item:hover { background: #f0f4ff; }
    .slider-row { display: flex; flex-direction: column; gap: 6px; margin-top: 6px; }
    .slider-row input[type="range"] { width: 100%; }
    details.legend {
      margin-top: 10px;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: #f5b342;
      display: inline-block;
      width: auto;
      max-width: 100%;
    }
    details.legend summary {
      font-weight: 600;
      cursor: pointer;
      outline: none;
      list-style: none;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    details.legend summary::-webkit-details-marker { display: none; }
    details.legend summary::before { content: ">"; font-size: 12px; }
    details.legend[open] summary::before { content: "v"; }
    .legend-row { display: flex; align-items: center; gap: 8px; font-size: 12px; margin: 3px 0; }
    .legend-swatch { width: 22px; height: 12px; border: 1px solid #333; border-radius: 3px; flex-shrink: 0; }
    .timelapse-row { display: flex; justify-content: flex-end; margin-top: 6px; }
    .timelapse-btn {
      padding: 8px 10px;
      border: none;
      border-radius: 6px;
      background: #f7941d;
      color: #111;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .timelapse-btn:hover { background: #f9a63f; }
    .timeline { display: none; margin-top: 8px; font-size: 12px; }
    .timeline-bar {
      position: relative;
      height: 10px;
      background: rgba(0,0,0,0.15);
      border-radius: 6px;
      overflow: hidden;
      margin-top: 4px;
    }
    .timeline-progress {
      position: absolute;
      left: 0; top: 0; bottom: 0;
      width: 0%;
      background: #c0392b;
      transition: width 0.1s linear;
    }
    .ol-popup {
      position: absolute;
      background: white;
      padding: 8px 10px;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25);
      font-family: system-ui, sans-serif;
      font-size: 13px;
      min-width: 200px;
    }
    .ol-popup a { color: #1a73e8; text-decoration: none; }
    .ol-popup a:hover { text-decoration: underline; }
    @media (max-width: 540px) {
      .panel {
        left: 50%;
        right: auto;
        transform: translateX(-50%);
        width: calc(100% - 24px);
      }
      .toggle-row { justify-content: center; }
      details.legend { margin-top: 8px; }
      .timelapse-btn { padding: 8px; }
      .timelapse-btn .tl-label { display: none; }
    }
  </style>
</head>
<body>
  <div class="panel">
    <h1>Suessmaus Karte Gemeindebau Wien</h1>
    <div class="search-box">
      <div style="position:relative;">
        <input id="hof-search" class="search-input" type="text" placeholder="Suche (HOFNAME) – min. 3 Zeichen" autocomplete="off">
        <div id="hof-suggestions" class="suggestions-list" style="display:none;"></div>
      </div>
    </div>
    <div style="margin-top:8px; margin-bottom:6px;" class="toggle-row">
      <div><strong>Basemap:</strong></div>
      <label><input type="radio" name="basemap" value="bmap" checked> Topo</label>
      <label><input type="radio" name="basemap" value="ortho"> Orthofoto</label>
      <label><input id="gemeindebau-toggle" type="checkbox" checked> Gemeindebau</label>
    </div>
    <div style="margin-top:4px;">
      <div style="font-weight:600;">Baujahr filtern <span id="year-labels">(1743 – 2025)</span></div>
      <div class="slider-row">
        <input id="year-min" type="range" min="1743" max="2025" value="1743">
        <input id="year-max" type="range" min="1743" max="2025" value="2025">
      </div>
      <div id="wohnungs-count" style="font-size:12px; margin-top:4px;">Wohnungsanzahl: -</div>
    </div>
    <details class="legend" id="legend">
      <summary>Legende</summary>
      <div id="legend-content"></div>
    </details>
    <div class="timelapse-row">
      <button id="timelapse-btn" class="timelapse-btn"><span>▶</span><span class="tl-label">Timelapse</span></button>
    </div>
    <div id="timeline" class="timeline">
      <div style="font-weight:600;">Timeline <span id="timeline-year"></span></div>
      <div class="timeline-bar">
        <div id="timeline-progress" class="timeline-progress"></div>
      </div>
    </div>
  </div>
  <div id="map"></div>

  <script src="https://cdn.jsdelivr.net/npm/ol@latest/dist/ol.js"></script>
  <script>
    const targetProjection = ol.proj.get("EPSG:3857");
    const minYearBase = 1743;
    const esriAttribution = "Tiles © Esri";

    const categoryColors = {
      pre1919: "#7a0010",
      zwischen: "#b00000",
      wieder: "#f28e2b",
      gross: "#4e79a7",
      postmodern: "#9c6ade",
      modern: "#59a14f"
    };
    const legendItems = [
      { key: "pre1919", label: "Vor 1919", color: categoryColors.pre1919 },
      { key: "zwischen", label: "Zwischenkriegszeit (1919–1934)", color: categoryColors.zwischen },
      { key: "wieder", label: "Wiederaufbau (1945–1970)", color: categoryColors.wieder },
      { key: "gross", label: "Großsiedlungen (1971–1980)", color: categoryColors.gross },
      { key: "postmodern", label: "Postmoderne (1981–1999)", color: categoryColors.postmodern },
      { key: "modern", label: "Gegenwart (2000–heute)", color: categoryColors.modern }
    ];

    const vectorSource = new ol.source.Vector();
    const styleCache = {};
    function styleByYear(feature, resolution) {
      const y = parseInt(feature.get("BAUJAHR"), 10);
      let key = "unknown";
      if (Number.isFinite(y)) {
        if (y < 1919) key = "pre1919";
        else if (y <= 1934) key = "zwischen";
        else if (y >= 1945 && y <= 1970) key = "wieder";
        else if (y >= 1971 && y <= 1980) key = "gross";
        else if (y >= 1981 && y <= 1999) key = "postmodern";
        else if (y >= 2000) key = "modern";
      }
      const width = Math.max(2.2, Math.min(9, 1.2 + resolution / 12));
      const cacheKey = `${key}-${Math.round(width * 10)}`;
      if (!styleCache[cacheKey]) {
        const fillColor = categoryColors[key] || "#cccccc";
        styleCache[cacheKey] = new ol.style.Style({
          stroke: new ol.style.Stroke({ color: fillColor, width }),
          fill: new ol.style.Fill({ color: fillColor + "cc" })
        });
      }
      return styleCache[cacheKey];
    }
    const gemeindebauLayer = new ol.layer.Vector({
      source: vectorSource,
      style: styleByYear
    });

    const baseLayerBmap = new ol.layer.Tile({
      source: new ol.source.XYZ({
        url: "https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",
        attributions: esriAttribution,
        crossOrigin: "anonymous",
        maxZoom: 19
      }),
      visible: true
    });
    const baseLayerOrtho = new ol.layer.Tile({
      source: new ol.source.XYZ({
        url: "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
        attributions: esriAttribution,
        crossOrigin: "anonymous",
        maxZoom: 19
      }),
      visible: false
    });

    const map = new ol.Map({
      target: "map",
      layers: [baseLayerBmap, baseLayerOrtho, gemeindebauLayer],
      view: new ol.View({
        projection: targetProjection,
        center: ol.proj.fromLonLat([16.3738, 48.2082], targetProjection),
        zoom: 13,
        minZoom: 4,
        maxZoom: 19
      })
    });
    gemeindebauLayer.setZIndex(1000);

    document.querySelectorAll("input[name='basemap']").forEach((radio) => {
      radio.addEventListener("change", () => {
        const val = document.querySelector("input[name='basemap']:checked").value;
        baseLayerBmap.setVisible(val === "bmap");
        baseLayerOrtho.setVisible(val === "ortho");
      });
    });
    document.getElementById("gemeindebau-toggle").addEventListener("change", (e) => {
      gemeindebauLayer.setVisible(e.target.checked);
    });

    const searchInput = document.getElementById("hof-search");
    const suggestionsBox = document.getElementById("hof-suggestions");

    const popupEl = document.createElement("div");
    popupEl.className = "ol-popup";
    const popup = new ol.Overlay({
      element: popupEl,
      autoPan: { animation: { duration: 200 } }
    });
    map.addOverlay(popup);

    fetch("GEMBAUTENFLOGD.json")
      .then((r) => {
        if (!r.ok) throw new Error(`GeoJSON load failed (${r.status})`);
        return r.json();
      })
      .then((data) => {
        const format = new ol.format.GeoJSON();
        const allFeatures = format.readFeatures(data, {
          dataProjection: "EPSG:4326",
          featureProjection: targetProjection
        });

        const years = allFeatures
          .map((f) => parseInt(f.get("BAUJAHR"), 10))
          .filter((n) => Number.isFinite(n));
        const minYear = Math.min(...years, minYearBase);
        const maxYear = Math.max(...years);
        const yearMin = document.getElementById("year-min");
        const yearMax = document.getElementById("year-max");
        const yearLabels = document.getElementById("year-labels");
        const wohnCountEl = document.getElementById("wohnungs-count");
        yearMin.min = minYearBase; yearMin.max = maxYear; yearMin.value = Math.max(minYearBase, minYear);
        yearMax.min = minYearBase; yearMax.max = maxYear; yearMax.value = maxYear;
        yearLabels.textContent = `(${yearMin.value} – ${yearMax.value})`;

        const legendEl = document.getElementById("legend-content");
        legendEl.innerHTML = legendItems.map(item =>
          `<div class="legend-row"><span class="legend-swatch" style="background:${item.color};"></span><span>${item.label}</span></div>`
        ).join("");

        const applyFilter = () => {
          let lo = parseInt(yearMin.value, 10);
          let hi = parseInt(yearMax.value, 10);
          if (lo > hi) lo = hi;
          if (hi < lo) hi = lo;
          yearMin.value = lo;
          yearMax.value = hi;
          yearLabels.textContent = `(${lo} – ${hi})`;
          const filtered = allFeatures.filter((f) => {
            const y = parseInt(f.get("BAUJAHR"), 10);
            return Number.isFinite(y) && y >= lo && y <= hi;
          });
          vectorSource.clear(true);
          vectorSource.addFeatures(filtered);
          const sumWohn = filtered.reduce((acc, f) => acc + (parseInt(f.get("WOHNUNGSANZAHL"), 10) || 0), 0);
          wohnCountEl.textContent = `Wohnungsanzahl: ${sumWohn.toLocaleString("de-DE")}`;
        };

        yearMin.addEventListener("input", applyFilter);
        yearMax.addEventListener("input", applyFilter);

        vectorSource.addFeatures(allFeatures);
        applyFilter();

        const nameIndex = allFeatures
          .map((f) => ({
            id: f.getId() || f.ol_uid,
            name: (f.get("HOFNAME") || "").toString(),
            nameLc: (f.get("HOFNAME") || "").toString().toLowerCase(),
            feature: f
          }))
          .filter((n) => n.nameLc.length > 0);

        const renderSuggestions = (matches) => {
          if (!matches.length) {
            suggestionsBox.style.display = "none";
            return;
          }
          suggestionsBox.innerHTML = matches
            .slice(0, 8)
            .map((m) => `<div class="suggestions-item" data-id="${m.id}">${m.name}</div>`)
            .join("");
          suggestionsBox.style.display = "block";
        };

        const doSearch = (query, fly = false) => {
          const q = query.toLowerCase().trim();
          if (q.length < 3) {
            renderSuggestions([]);
            return;
          }
          const matches = nameIndex.filter((n) => n.nameLc.includes(q));
          renderSuggestions(matches);
          if (fly && matches.length) {
            const f = matches[0].feature;
            const geom = f.getGeometry();
            if (geom) {
              map.getView().fit(geom.getExtent(), { padding: [30, 30, 30, 30], duration: 200 });
            }
          }
        };

        searchInput.addEventListener("input", () => doSearch(searchInput.value));
        searchInput.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            doSearch(searchInput.value, true);
            suggestionsBox.style.display = "none";
          }
          if (e.key === "Escape") suggestionsBox.style.display = "none";
        });
        suggestionsBox.addEventListener("click", (e) => {
          const id = e.target.getAttribute("data-id");
          if (!id) return;
          const match = nameIndex.find((n) => (n.id || "").toString() === id.toString());
          if (match) {
            const geom = match.feature.getGeometry();
            if (geom) {
              map.getView().fit(geom.getExtent(), { padding: [30, 30, 30, 30], duration: 200 });
            }
            searchInput.value = match.name;
          }
          suggestionsBox.style.display = "none";
        });

        map.on("pointerdown", () => {
          suggestionsBox.style.display = "none";
        });

        const tlBtn = document.getElementById("timelapse-btn");
        const timeline = document.getElementById("timeline");
        const tlYear = document.getElementById("timeline-year");
        const tlProgress = document.getElementById("timeline-progress");
        let tlTimer = null;
        const TL_START = minYearBase;
        const TL_END = Math.min(2023, maxYear);
        const FAST_DELAY = 60;
        const SLOW_DELAY = 170;

        const stopTimelapse = () => {
          if (tlTimer) clearTimeout(tlTimer);
          tlTimer = null;
          tlBtn.innerHTML = '<span>▶</span><span class="tl-label">Timelapse</span>';
          timeline.style.display = "none";
        };

        const startTimelapse = () => {
          timeline.style.display = "block";
          tlBtn.innerHTML = '<span>⏸</span><span class="tl-label">Stop</span>';
          let current = TL_START;
          const step = () => {
            yearMin.value = TL_START;
            yearMax.value = current;
            applyFilter();
            const pct = ((current - TL_START) / (TL_END - TL_START)) * 100;
            tlProgress.style.width = `${Math.max(0, Math.min(100, pct))}%`;
            tlYear.textContent = current;
            current += 1;
            if (current > TL_END) {
              stopTimelapse();
              return;
            }
            const delay = current < 1900 ? FAST_DELAY : SLOW_DELAY;
            tlTimer = setTimeout(step, delay);
          };
          step();
        };

        tlBtn.addEventListener("click", () => {
          if (tlTimer) stopTimelapse();
          else startTimelapse();
        });
      })
      .catch((err) => {
        console.error(err);
        alert("Konnte die GeoJSON nicht laden. Details in der Konsole.");
      });

    map.on("singleclick", (evt) => {
      popup.setPosition(undefined);
      map.forEachFeatureAtPixel(evt.pixel, (feature) => {
        const p = feature.getProperties();
        popupEl.innerHTML = `
          <div style="font-weight:700;margin-bottom:4px;">${p.HOFNAME || "Gemeindebau"}</div>
          <div><strong>Baujahr:</strong> ${p.BAUJAHR || "-"}</div>
          <div><strong>Adresse:</strong> ${p.ADRESSE || "-"}</div>
          <div><strong>Wohnungsanzahl:</strong> ${p.WOHNUNGSANZAHL ?? "-"}</div>
          <div><strong>Bezirk:</strong> ${p.BEZIRK ?? "-"}</div>
          <div><a href="${p.PDFLINK || "#"}" target="_blank" rel="noopener">PDF</a></div>
        `;
        popup.setPosition(evt.coordinate);
        return true;
      });
    });
  </script>
</body>
</html>
