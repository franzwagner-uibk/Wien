<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Süßmaus Karte Gemeindebau Wien</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@latest/ol.css">
  <style>
    html, body { margin: 0; height: 100%; }
    #map { width: 100%; height: 100%; }
    .panel {
      position: absolute;
      top: 12px;
      left: 12px;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.92);
      padding: 10px 12px;
      border-radius: 6px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      font-size: 14px;
      line-height: 1.4;
    }
    .panel h1 {
      margin: 0 0 6px;
      font-size: 16px;
      font-weight: 700;
    }
    .panel label {
      display: flex;
      align-items: center;
      gap: 6px;
      user-select: none;
    }
  </style>
</head>
<body>
  <div class="panel">
    <h1>Süßmaus Karte Gemeindebau Wien</h1>
    <label><input id="gemeindebau-toggle" type="checkbox" checked> Gemeindebau</label>
  </div>
  <div id="map"></div>

  <!-- Use prebuilt OpenLayers bundle (avoids bare-specifier issues) -->
  <script src="https://cdn.jsdelivr.net/npm/proj4@2.9.1/dist/proj4.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ol@latest/dist/ol.js"></script>
  <script>
    const wmtsUrl = "https://mapsneu.wien.gv.at/basemap31256neu/1.0.0/WMTSCapabilities.xml";
    const wfsUrl = "https://data.wien.gv.at/daten/geo";
    const targetProjectionCode = "EPSG:31256";

    // Register EPSG:31256 for OL (Bessel + towgs84)
    proj4.defs(
      targetProjectionCode,
      "+proj=tmerc +lat_0=0 +lon_0=16 +k=1 +x_0=0 +y_0=-5000000 +ellps=bessel " +
        "+towgs84=577.326,90.129,463.919,5.137,1.474,5.297,2.4232 +units=m +no_defs"
    );
    ol.proj.proj4.register(proj4);
    const targetProjection = ol.proj.get(targetProjectionCode);

    async function buildMap() {
      // Parse WMTS capabilities for basemap.at (EPSG:31256)
      const wmtsResponse = await fetch(wmtsUrl);
      if (!wmtsResponse.ok) throw new Error(`WMTS capabilities request failed (${wmtsResponse.status})`);
      const capabilitiesText = await wmtsResponse.text();
      const capabilities = new ol.format.WMTSCapabilities().read(capabilitiesText);
      const wmtsOptions = ol.source.WMTS.optionsFromCapabilities(capabilities, {
        layer: "bmap",
        matrixSet: "31256",
        style: "farbe"
      });

      const basemap = new ol.layer.Tile({
        source: new ol.source.WMTS(wmtsOptions)
      });

      const gemeindebauLayer = new ol.layer.Vector({
        source: new ol.source.Vector({
          format: new ol.format.GeoJSON(),
          url: `${wfsUrl}?service=WFS&version=1.1.0&request=GetFeature&typeName=${encodeURIComponent(
            "ogdwien:GEMBAUTENFLOGD"
          )}&srsName=${encodeURIComponent(targetProjectionCode)}&outputFormat=application/json`
        }),
        style: new ol.style.Style({
          stroke: new ol.style.Stroke({ color: "#c0392b", width: 1.4 }),
          fill: new ol.style.Fill({ color: "rgba(192,57,43,0.25)" })
        })
      });

      const map = new ol.Map({
        target: "map",
        layers: [basemap, gemeindebauLayer],
        view: new ol.View({
          projection: targetProjection,
          center: ol.proj.fromLonLat([16.3738, 48.2082], targetProjection), // Vienna center
          zoom: 12,
          minZoom: 4,
          maxZoom: 18
        })
      });

      // Toggle visibility
      const toggle = document.getElementById("gemeindebau-toggle");
      toggle.addEventListener("change", () => {
        gemeindebauLayer.setVisible(toggle.checked);
      });
    }

    buildMap().catch((err) => {
      console.error("Map setup failed:", err);
      alert("Map setup failed. See console for details.");
    });
  </script>
</body>
</html>
